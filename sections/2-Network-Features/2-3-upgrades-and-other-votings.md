# Обновления протокола и другие голосования

Как вы могли понять из предыдущего раздела, протокол работы блокчейна, в особенности Waves NG, совсем нетривиальная штука. Но как и любой протокол, он может и должен меняться со временем, чтобы становиться лучше. Но тут не все так просто. Команда разработки Waves не может просто так выпустить обновления и приказать всем обновиться или сказать, что те, кто не обновится, перестанут работать - это противоречит принципам децентрализации. Многие блокчейны идут по пути жестких "форков", просто выпускается новый функционал с новой версией ноды, дальше кому надо - устанавливает и начинает майнить с поддержкой новой фичи. Кто согласен - переключается на новую цепочку, кто нет - продолжает майнить старую. Этот путь далеко не лучший и может вести к бесчисленному количеству форков, поэтому добавление нового функционала или изменение правил консенуса в Waves возможно только через процедуру предложения нового функционала и голосование.

Процедуру изменения параметров консенсуса с помощью голосований часто называют гаверненсом (governance). Мы не будем использовать это слово, потому что governance в Waves сейчас ограничен двумя типами голосований, в то время как во многих других блокчейнах возможных изменений гораздо больше (баны аккаунтов, жесткие изменения балансов аккаунтов и другие зверства, плохо уживающиеся с принципами децентрализации).

## Процедура предложения нового функционала

В экосистеме Waves есть неписанное правило (писанного быть не может, децентрализация ведь), что все новые функции и изменения консенсуса должны проходить через процедуру обсуждения. Все предложения по изменения являются так называемыми Waves Enhancement Proposal или WEP. У каждого WEP есть порядковый номер, четка определенная структура и вопросы, на которые это предложение должно отвечать. Форма WEP была предложена на форуме Waves в специальном разделе, но в данный момент основные обсуждения и предложения на github.

Итак, каждое предложение формулируется в виде WEP, далее это предложение обсуждается всеми заинтересованными сторонами, вносятся корректировки, уточняются формулировки и т.д. В конечно итоге, любой человек может реализовать предложенный WEP в коде ноды (репозиторий ведь открытый) и отправить Pull Request на добавление изменений в основную ветку разработки. Команда Waves отвечает за качество кода в репозитории, поэтому при отсутствии проблем с качеством, код будет добавлен в основную ветку и попадет в сборку следующего релиза, которые так же публикуются на github. Но это не говорит о том, что новый код начнет работать, потому что каждый новый функционал (далее фича, от слова "feature") должен быть одобрен не только разработчиками, но и сообществом, для этого запускается процедура голосования.

<!-- TODO: добавить ссылки на WEP -->

## Голосования за правила консенсуса

Как только владелец ноды устанавливает новую версию, у него появлется возможность голосовать за то, чтобы новая фича была активирована. У каждой фичи есть порядкой номер, по которому идет голосование и идентификация, обычно номера новых фич перечислены в описаниях к релизу на Github, но так же можно посмотреть в API ноды. Владелец ноды может добавить номер поддерживамой фичи в свою конфигурацию в массив `waves.features.supported`. После этого (а точнее после перезапуска ноды) в каждый генерируемый блок от этой ноды начинает добавляться номер поддерживаемой фичи. То есть, в бинарном представлении блока (в котором и идет работа), появляется новое значение с номером фичи.

Для того, чтобы фича была активирована, необходимо, чтобы ее поддержка была не менее 80% - не менее 80% блоков за период голосования должны в себе содержать информацию о поддержке фичи. Периоды голосования начинаются на каждом кратном десяти-тысячном блое (блок номер 100 000, 110 000, 120 000 и т.д.). Проще говоря, из блоков с номерами 100000-109999 не менее 80% содержать информацию о поддержке новой фичи.

Фактически гаверненс в Waves устроен очень близко к тому, как работает система выборов президента США. Жители страны напрямую не голосуют за президента, они выбирают представителей от каждого штата (количество представителей разнится от штата к штату. Представители уже непосредственно голосуют за президента США.

В Waves владельцы токенов могут напрямую голосовать за активацию фичи, однако, в большинстве случаев они не имеют своих нод и сдают свои токены в лизинг, передавая, таким образом, свое право голоса, владельцу лизингового пула. Важно понимать, что они в любой момент могут отменить лизинг, если владелец пула голосует не так, как они хотели бы, что снизит количество блоков, которые сгенерирует данный пул. Самые большие пулы в Waves часто делают голосования среди лизеров с помощью децентрализованных приложений (мы рассмотрим пример такого голосования в разделе 7), так что и представительская *демократия*/децентрализация могут быть прозрачными.

Если фича была поддержана более чем 80% стейка, то она будет активирована через 10000 блоков с момента завершения периода голосования. Например, если голосование была во время блоков 10000-19999, то фича станет активной на высоте 30000. Данная задержка позволяет еще раз проверить, что все нормально и новая фича не вызовет форки.

<!-- TODO: зачем на самом деле нужна эта задержка? -->

Если посмотреть в код ноды или в API (`/activation/status`), то можно заметить, что у каждой фичи есть следующие возможные статусы:

- **VOTING** - идет голосование по фиче
- **APPROVED** - фича одобрена, но пока не активирована (из-за задержки в 10 000 блоков)
- **ACTIVATED** - фича активирована, все ноды на этой цепочке должны поддерживать данную фичу

Как видите, у фичи нет статуса `REJECTED`, то есть голосование за фичу может идти бесконечно.

## Голосование за вознаграждение за блок

В Waves есть еще один вид голосования нодами, который не встречается практически нигде - голосование за вознаграждение за блок. В 2016 году блокчейн Waves запускался с ограниченной эмиссией токенов - 100 миллионов, коорые уже были созданы на момент запуска сети. Но осенью 2019 года комьюнити осознало, что все-таки модель с эмиссией является более живой, поэтому было предложение обновление - WEP-7, которое прошло через процедуру голосования и на блоке N фича была активирована. Теперь за каждый сгенерированный блок, майнер получает не только комиссии (и то 40% от своего блока и 60% от предыдущего, вы ведь помните про Waves NG?), но и получает Waves, "генерируемые из воздуха". Примерно каждую минуту общее количество Waves в природе увеличивается на определенное значение. На какое именно значение - предмет голосования нод.

Каждые 100 тысяч блоков (примерно 2 с половиной месяца) начинается голосование за величину вознаграждения. В момент активации фичи N было установлено значение в 6 Waves. Каждые 100 000 блоков это значение может меняться не больше, чем на 0.5 Waves, и то при условии поддержки более чем 50% майнеров.

Голосование за вознаграждение за блок осуществляется немного по другому принципу, не как в случае с фичами. Владельцы нод могут в своем конфигурационном файле в параметре `waves.reward.desired` установить значение вознаграждения, которое хотели бы увидеть в долгосрочной перспективе. По истечении периода голосования, подсчитывается сколько блоков содержат желаемое вознаграждение больше, чем текущее, и если больше 50%, то вознаграждение увеличивается на 0.5 Waves на следующие 110 000 блоков (наступление нового периода голосования + сам период голосования).

Некоторые участники сообщество спрашивали, почему в `waves.reward.desired` просто не указывать `+` или `-`, раз все равно вознаграждение не будет изменено больше, чем на 0.5 Waves. Указание желаемого вознаграждения в долгосрочной перспективе избавляет от необходимости частого изменения конфигурации. Вы можете поставить значение `10` и не лезть каждый период голосования в конфигурацию, так как вы будете голосовать за увеличение до тех пор, пока вознаграждение не достигнет 10 Waves за блок. А как только достигнет (если достигнет), нода перестанет голосовать за увеличение вознаграждения. Так просто.

<!-- TODO: Добавить ссылку на WEP-7 и на какой высоте была активация-->